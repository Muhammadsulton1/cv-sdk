# 🏗️ Архитектура системы обработки видео в реальном времени

## Обзор системы

Распределенная микросервисная система для обработки видеопотоков с использованием машинного обучения. Система построена на событийно-ориентированной архитектуре с использованием брокера сообщений NATS и распределенного хранилища SeaweedFS.

## Архитектурная диаграмма

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           СИСТЕМА ОБРАБОТКИ ВИДЕО                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ВИДЕО ИСТОЧНИК │    │   ИНФРАСТРУКТУРА │    │   ОБРАБОТКА ИИ  │    │  РЕГИСТРАЦИЯ    │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  📹 Видеофайл   │    │  🗄️ SeaweedFS   │    │ 🧠 Detection    │    │ 📝 Event        │
│  📡 RTSP поток  │    │     Master      │    │    Inference    │    │   Registrator   │
│                 │    │   (Port 9333)   │    │                 │    │                 │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │                      │
          │                      │                      │                      │
┌─────────▼───────┐    ┌─────────▼───────┐    ┌─────────▼───────┐    ┌─────────▼───────┐
│ 📖 VideoReader  │    │  💾 Volume      │    │ 🔍 Classification│    │ 🎬 VideoWriter  │
│                 │    │   (Port 8080)   │    │    Inference    │    │                 │
│ • AVReader      │    │                 │    │                 │    │ • Frame Buffer  │
│ • OpenCVReader  │    │  🌐 Filer       │    │                 │    │ • Video Export  │
│                 │    │   (Port 8888)   │    │                 │    │ • Event Storage │
└─────────┬───────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
          │
          │ Кадры (JPEG)
          │
┌─────────▼───────┐    ┌─────────────────┐    ┌─────────────────┐
│ 📤 SeaweedFS    │    │  📨 NATS        │    │ 📊 Redis        │
│   Uploader      │    │   Broker        │    │ Service Discovery│
│                 │    │  (Port 4222)    │    │  (Port 6379)    │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          │ URL кадра            │                      │
          │                      │                      │
┌─────────▼───────┐              │              ┌───────▼───────┐
│ 📡 NATS         │              │              │ 🔄 Heartbeat  │
│   Publisher     │              │              │   Monitoring  │
│                 │              │              │               │
│ Topic:          │              │              │ • TTL: 10s    │
│ frames-stream   │              │              │ • Auto cleanup│
└─────────┬───────┘              │              └───────────────┘
          │                      │
          │ Сообщение с          │
          │ метаданными          │
          │                      │
┌─────────▼───────┐              │
│ 🚦 Router       │              │
│   Manager       │              │
│                 │              │
│ • Получает кадры│              │
│ • Выбирает      │              │
│   модели ИИ     │              │
│ • Маршрутизирует│              │
└─────────┬───────┘              │
          │                      │
          │ Распределение        │
          │ по моделям           │
          │                      │
┌─────────▼───────┐              │
│ 📬 NATS Topics  │◄─────────────┘
│                 │
│ • DetectionInference
│ • ClassificationInference
│ • [Другие модели]
└─────────┬───────┘
          │
          │ Задачи для
          │ обработки
          │
┌─────────▼───────┐
│ 🤖 AI Models    │
│                 │
│ • Загрузка      │
│   изображений   │
│ • Предобработка │
│ • Инференс      │
│ • Постобработка │
└─────────┬───────┘
          │
          │ Результаты
          │
┌─────────▼───────┐
│ 📤 Results      │
│   Publisher     │
│                 │
│ Topic:          │
│ inference.results│
└─────────┬───────┘
          │
          │ Результаты
          │ обработки
          │
┌─────────▼───────┐
│ 📝 Event        │
│   Registrator   │
│                 │
│ • Сбор событий  │
│ • Создание видео│
│ • Сохранение    │
│   в Redis       │
└─────────────────┘
```

## Компоненты системы

### 1. 📹 Источник видео
- **Поддерживаемые форматы**: Видеофайлы, RTSP потоки
- **Конфигурация**: `.env` файл
- **Параметры**: Пропуск кадров, индекс потока

### 2. 📖 VideoReader
**Назначение**: Чтение и обработка видеопотока

**Реализации**:
- `AVReader` - для RTSP потоков (библиотека av)
- `OpenCVReader` - для видеофайлов (OpenCV)

**Функции**:
- Извлечение кадров из видео
- Конвертация в JPEG
- Загрузка в SeaweedFS
- Публикация метаданных в NATS

### 3. 🗄️ SeaweedFS (Распределенное хранилище)
**Компоненты**:
- **Master** (9333) - координация и метаданные
- **Volume** (8080) - хранение данных
- **Filer** (8888) - файловый интерфейс

**Особенности**:
- TTL для автоматической очистки
- Горизонтальное масштабирование
- S3-совместимый API

### 4. 📨 NATS (Брокер сообщений)
**Топики**:
- `frames-stream` - поток кадров от VideoReader
- `DetectionInference` - задачи для детекции
- `ClassificationInference` - задачи для классификации
- `inference.results` - результаты обработки

**Особенности**:
- Асинхронная обработка
- Автоматическое переподключение
- Поддержка JetStream

### 5. 🚦 RouterManager
**Назначение**: Маршрутизация сообщений между компонентами

**Функции**:
- Получение кадров из `frames-stream`
- Обнаружение доступных моделей ИИ
- Распределение задач по моделям
- Балансировка нагрузки

### 6. 📊 Redis (Service Discovery)
**Назначение**: Отслеживание активных сервисов

**Функции**:
- Регистрация моделей ИИ
- Heartbeat мониторинг (TTL: 10s)
- Автоматическая очистка неактивных сервисов

### 7. 🤖 AI Models (Модели машинного обучения)
**Базовые типы**:
- `DetectionInference` - детекция объектов
- `ClassificationInference` - классификация изображений

**Пайплайн обработки**:
1. **Загрузка** изображения по URL из SeaweedFS
2. **Предобработка** (resize, нормализация)
3. **Инференс** (выполнение модели)
4. **Постобработка** (форматирование результатов)

### 8. 📝 EventRegistrator (Регистратор событий)
**Назначение**: Сбор и агрегация результатов обработки

**Компоненты**:
- `AbstractEventRegistrator` - базовый класс
- `BasicEventRegistrator` - основная реализация
- `VideoWriter` - создание видеодоказательств

**Функции**:
- Подписка на топик `inference.results`
- Управление жизненным циклом задач (CREATED → PENDING → DONE → FINISHED)
- Сбор кадров для создания видео
- Сохранение событий в Redis с временными метками
- Создание видеодоказательств (MP4) и ключевых кадров (JPEG)

**Состояния задач**:
- `CREATED` - задача создана
- `PENDING` - обработка в процессе
- `DONE` - обработка завершена
- `FINISHED` - видео сохранено
- `ERROR` - ошибка сохранения

## Поток данных

```
Видео → VideoReader → SeaweedFS → NATS → Router → AI Models → Results → EventRegistrator
  │         │           │         │       │         │          │           │
  │         │           │         │       │         │          │           │
  ▼         ▼           ▼         ▼       ▼         ▼          ▼           ▼
Кадры → JPEG файлы → URL → Метаданные → Задачи → Обработка → Результаты → События/Видео
```

### Детальный поток:

1. **VideoReader** извлекает кадры из видео
2. Кадры конвертируются в JPEG и загружаются в **SeaweedFS**
3. Метаданные кадра (URL, timestamp, frame_id) публикуются в **NATS**
4. **RouterManager** получает сообщения и определяет доступные модели
5. Задачи распределяются по топикам моделей в **NATS**
6. **AI Models** получают задачи, загружают изображения и обрабатывают
7. Результаты публикуются в топик `inference.results`
8. **EventRegistrator** получает результаты, собирает кадры и создает видеодоказательства
9. События сохраняются в **Redis** с временными метками для дальнейшего анализа

## Конфигурация

### Переменные окружения (.env)
```bash
# Источник видео
video_source=./video/test_maneken.mp4
video_skip_frames=0
reader_type=av

# SeaweedFS
master_url=http://localhost:9333
volume_url=http://localhost:8888
ttl_bucket=5m

# NATS
nats_host=nats://localhost:4222
topic_stream=frames-stream

# Redis
redis_host=localhost
redis_port=6379
routing_ttl=10

# EventRegistrator
TMP_PATH=../tmp
```

## Масштабирование

### Горизонтальное масштабирование:
- **AI Models**: Запуск нескольких экземпляров одной модели
- **SeaweedFS**: Добавление Volume серверов
- **NATS**: Кластеризация серверов

### Вертикальное масштабирование:
- Увеличение ресурсов для моделей ИИ
- Оптимизация моделей (TensorRT, ONNX)
- Настройка TTL и буферизации

## Отказоустойчивость

### Механизмы:
- **Heartbeat** мониторинг сервисов в Redis
- **Автоматическое переподключение** к NATS
- **TTL** для автоматической очистки данных
- **Graceful shutdown** всех компонентов

### Обработка ошибок:
- Логирование всех операций
- Retry механизмы для сетевых операций
- Валидация входных данных
- Мониторинг состояния сервисов

## Технологический стек

- **Python 3.8+** - основной язык
- **Docker & Docker Compose** - контейнеризация
- **NATS** - брокер сообщений
- **Redis** - кэш и service discovery
- **SeaweedFS** - распределенное хранилище
- **OpenCV/AV** - обработка видео
- **PyTorch/ONNX/TensorRT** - машинное обучение
- **aiohttp** - асинхронные HTTP запросы

## Дополнительные компоненты

### 📝 EventRegistrator - Система регистрации событий

**Архитектура EventRegistrator**:

```
┌─────────────────────────────────────────────────────────────┐
│                    EVENT REGISTRATOR                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ 📨 NATS         │    │ 🎬 VideoWriter  │    │ 📊 Redis        │
│ Subscriber      │    │                 │    │ Event Store     │
│                 │    │ • Frame Buffer  │    │                 │
│ Topic:          │    │ • Video Export  │    │ • Sorted Set    │
│ inference.results│    │ • Key Frames   │    │ • Timestamps    │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          │ Результаты           │ Кадры                │ События
          │ обработки            │                      │
          │                      │                      │
┌─────────▼───────┐              │              ┌───────▼───────┐
│ 📋 Task         │              │              │ 💾 Event      │
│ Catalog         │              │              │ Storage       │
│                 │              │              │               │
│ • CREATED       │              │              │ Key: events   │
│ • PENDING       │              │              │ Value: JSON   │
│ • DONE          │              │              │ Score: time   │
│ • FINISHED      │              │              │               │
│ • ERROR         │              │              │               │
└─────────┬───────┘              │              └───────────────┘
          │                      │
          │ Управление           │
          │ состоянием           │
          │                      │
┌─────────▼──────────────────────▼───────┐
│ 🎯 Event Processing Pipeline           │
│                                        │
│ 1. Получение результата из NATS        │
│ 2. Обновление статуса задачи           │
│ 3. Сбор кадров для видео               │
│ 4. Создание видеодоказательства        │
│ 5. Сохранение события в Redis          │
└────────────────────────────────────────┘
```

**Жизненный цикл события**:

```
CREATED → PENDING → DONE → FINISHED
    │         │       │        │
    │         │       │        └─→ Видео сохранено
    │         │       └─→ Обработка завершена
    │         └─→ Обработка в процессе  
    └─→ Задача создана

                    ↓ (при ошибке)
                  ERROR
```

**Структура данных в Redis**:
```json
{
  "task_key": {
    "message": {
      "model": "DetectionInference",
      "result": {...},
      "frame_id": "frame_000123"
    },
    "video_proofs": "/tmp/uuid/uuid.mp4",
    "image_proof_path": "/tmp/uuid/uuid.jpg"
  }
}
```

**Особенности**:
- Автоматическое создание директорий для каждого события
- Сохранение ключевого кадра как JPEG
- Создание видео из собранных кадров (H.264, 10 FPS)
- Использование sorted set в Redis для хронологического хранения
- Подсчет наиболее частых результатов с помощью Counter